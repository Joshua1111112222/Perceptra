<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="apple-mobile-web-app-title" content="Perceptra">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="logo.png">
    <meta http-equiv="X-UA-Compatible" content="ie=chrome">
    <link rel="icon" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff"> <!-- Android Chrome -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="style.css">
    <style>
        .perceptra-heading {
            color: #662d91;
            text-align: center;
        }

        .container {
            max-height: 100vh;
            overflow-y: auto;
            padding: 20px;
        }

        .clear-all-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .clear-all-btn:hover {
            background-color: darkred;
        }
        
        /* Added online status style - matches existing design */
        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px 15px;
            background-color: #662d91;
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="static-heading" class="perceptra-heading" style="display: none;">Perceptra</h1>
        <h2 id="welcome-message" class="perceptra-heading">Perceptra</h2>

        <!-- Added connection status indicator -->
        <div id="connection-status" class="connection-status hidden"></div>

        <div id="username-section">
            <label for="username">Enter your Username:</label>
            <input type="text" id="username" placeholder="Your Username">
            <button onclick="nextStep()">Next</button>
        </div>

        <div id="team-section" class="hidden">
            <label for="team-name">Enter Team Name:</label>
            <input type="text" id="team-name" placeholder="Team Name">
            <label for="team-number">Enter Team Number:</label>
            <input type="number" id="team-number" placeholder="Team Number">
            <div class="ratings">
                <label>Tell Amount Scored or Rate the Team (1-10): </label>
                <input type="number" id="defense" placeholder="Defense" min="1" max="10">
                <input type="number" id="strategy" placeholder="Strategy" min="1" max="10">
                <input type="number" id="effectiveness" placeholder="Effectiveness" min="1" max="10">
                <input type="number" id="drive-skill" placeholder="Drive Skill" min="1" max="10">
                <input type="number" id="scoring" placeholder="Scoring" min="1" max="10">
                <input type="number" id="consistency" placeholder="Consistency" min="1" max="10">
            </div>
            <textarea id="notes" placeholder="Additional Notes Add Autonomous and Endgame Info Here"></textarea>
            <button onclick="submitData()">Submit</button>
            <button onclick="goBack()">Back</button>
        </div>

        <div id="admin-login">
            <button onclick="showAdmin()">Admin</button>
        </div>

        <div id="admin-section" class="hidden">
            <label for="admin-password">Enter Admin Password:</label>
            <input type="password" id="admin-password" placeholder="Enter Admin Password">
            <button onclick="accessAdmin()">Submit</button>
        </div>

        <div id="upload-section">
            <button id="upload-btn" onclick="uploadData()">Upload (<span id="forms-count">0</span>)</button>
        </div>

        <div id="rankings-section" class="hidden">
            <h2>Rankings</h2>
            <table id="rankings-table">
                <thead>
                    <tr>
                        <th>Team Name</th>
                        <th>Team Number</th>
                        <th>Avg Score</th>
                        <th>Highest Score</th>
                        <th>Submitted By</th>
                        <th>Defense</th>
                        <th>Strategy</th>
                        <th>Effectiveness</th>
                        <th>Drive Skill</th>
                        <th>Scoring</th>
                        <th>Consistency</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="rankings-body"></tbody>
            </table>
            <button class="clear-all-btn" onclick="clearAllEntries()">Clear All</button>
        </div>
    </div>

    <script>
           const allowedUsernames = ["Joshua The", "Caleb Wieland", "Parker Montgomery", "Nathan Hurd", "Evan Sylvester", "Bentley Kucmierz", "Loriel Achonduh",];

function nextStep() {
    const username = document.getElementById("username").value.trim();
    if (!username) {
        alert("Please enter a username");
        return;
    }
    if (!allowedUsernames.includes(username)) {
        alert("Access denied. You are not on The Atomic Toasters Robotics. Please contact Joshua.");
        // Clear the input and keep them on the username page
        document.getElementById("username").value = "";
        return;
    }

    // Only proceed if username is valid
    document.getElementById("welcome-message").innerText = `Welcome back, ${username}`;
    document.getElementById("static-heading").style.display = "block";
    document.getElementById("username-section").classList.add("hidden");
    document.getElementById("team-section").classList.remove("hidden");
}

        const LOCAL_STORAGE_KEY = "perceptra_unsynced_data";
        const BACKEND_URL = "https://backend-8i2m.onrender.com";
        
        // Track connection status
        let isOnline = navigator.onLine;
        updateConnectionStatus();
        
        // Monitor connection changes
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
        });
        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
        });

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = isOnline ? 'Online' : 'Offline';
            statusEl.style.backgroundColor = isOnline ? '#00FF00' : '#FF0000'; // Green for online, red for offline
            statusEl.classList.remove('hidden');
        }

        function getUnsyncedData() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveToLocalStorage(data) {
            const unsyncedData = getUnsyncedData();
            unsyncedData.push(data);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(unsyncedData));
            updateFormsCount();
        }

        function updateFormsCount() {
            document.getElementById('forms-count').textContent = getUnsyncedData().length;
        }
        function goBack() {
            document.getElementById("team-section").classList.add("hidden");
            document.getElementById("username-section").classList.remove("hidden");
            document.getElementById("static-heading").style.display = "none";
            document.getElementById("welcome-message").innerText = "Perceptra";
        }

        function showAdmin() {
            document.getElementById("admin-login").classList.add("hidden");
            document.getElementById("admin-section").classList.remove("hidden");
        }

        function accessAdmin() {
            const password = document.getElementById("admin-password").value.trim();
            if (password === "admin") {
                alert("Access granted!");
                document.getElementById("admin-section").classList.add("hidden");
                document.getElementById("rankings-section").classList.remove("hidden");
                fetchRankings();
            } else {
                alert("Invalid password. Please try again.");
            }
        }

        function submitData() {
            const formData = {
                username: document.getElementById("username").value.trim(),
                teamName: document.getElementById("team-name").value.trim(),
                teamNumber: document.getElementById("team-number").value.trim(),
                defense: document.getElementById("defense").value,
                strategy: document.getElementById("strategy").value,
                effectiveness: document.getElementById("effectiveness").value,
                driveSkill: document.getElementById("drive-skill").value,
                scoring: document.getElementById("scoring").value,
                consistency: document.getElementById("consistency").value,
                notes: document.getElementById("notes").value.trim(),
                timestamp: new Date().toISOString()
            };

            if (!formData.teamName || !formData.teamNumber) {
                alert("Please enter team name and number");
                return;
            }

            saveToLocalStorage(formData);
            alert("Data saved locally!");

            // Clear form
            document.getElementById("team-name").value = "";
            document.getElementById("team-number").value = "";
            document.getElementById("defense").value = "";
            document.getElementById("strategy").value = "";
            document.getElementById("effectiveness").value = "";
            document.getElementById("drive-skill").value = "";
            document.getElementById("scoring").value = "";
            document.getElementById("consistency").value = "";
            document.getElementById("notes").value = "";
        }

        function uploadData() {
            const unsyncedData = getUnsyncedData();
            
            if (unsyncedData.length === 0) {
                alert("No data to upload");
                return;
            }

            if (!isOnline) {
                alert("Cannot upload while offline");
                return;
            }

            // Upload each item one by one
            uploadNextItem(0);
        }

        function uploadNextItem(index) {
            const unsyncedData = getUnsyncedData();
            
            if (index >= unsyncedData.length) {
                alert("All data uploaded successfully!");
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                updateFormsCount();
                return;
            }

            const dataItem = unsyncedData[index];
            
            fetch(`${BACKEND_URL}/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataItem)
            })
            .then(response => {
                if (!response.ok) throw new Error('Upload failed');
                
                // Remove successfully uploaded item
                const updatedData = getUnsyncedData();
                updatedData.splice(index, 1);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(updatedData));
                updateFormsCount();
                
                // Upload next item
                uploadNextItem(index);
            })
            .catch(error => {
                console.error('Error uploading item:', error);
                alert(`Failed to upload item ${index + 1}. Trying next item...`);
                uploadNextItem(index + 1);
            });
        }

        function fetchRankings() {
            fetch(`${BACKEND_URL}/rankings`)
                .then(response => response.json())
                .then(data => {
                    const rankingsBody = document.getElementById("rankings-body");
                    rankingsBody.innerHTML = "";
                    data.forEach((entry) => {
                        const row = rankingsBody.insertRow();
                        row.insertCell(0).innerText = entry.teamName;
                        row.insertCell(1).innerText = entry.teamNumber;
                        row.insertCell(2).innerText = entry.avgScore;
                        row.insertCell(3).innerText = entry.highestScore;
                        row.insertCell(4).innerText = entry.username;
                        row.insertCell(5).innerText = entry.defense;
                        row.insertCell(6).innerText = entry.strategy;
                        row.insertCell(7).innerText = entry.effectiveness;
                        row.insertCell(8).innerText = entry.driveSkill;
                        row.insertCell(9).innerText = entry.scoring;
                        row.insertCell(10).innerText = entry.consistency;
                        row.insertCell(11).innerText = entry.notes;

                        const deleteCell = row.insertCell(12);
                        const deleteButton = document.createElement("button");
                        deleteButton.innerText = "Delete";
                        deleteButton.style.backgroundColor = "red";
                        deleteButton.style.color = "white";
                        deleteButton.style.border = "none";
                        deleteButton.style.padding = "5px 10px";
                        deleteButton.style.cursor = "pointer";
                        deleteButton.onclick = () => deleteEntry(entry.teamNumber);
                        deleteCell.appendChild(deleteButton);
                    });
                })
                .catch(error => console.error("Error fetching rankings:", error));
        }

        function deleteEntry(teamNumber) {
            if (confirm("Are you sure you want to delete this entry?")) {
                fetch(`${BACKEND_URL}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ teamNumber })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Delete failed');
                    alert('Entry deleted successfully!');
                    fetchRankings();
                })
                .catch(error => {
                    console.error('Error deleting entry:', error);
                    alert('Failed to delete entry. Please try again.');
                });
            }
        }

        function clearAllEntries() {
            if (confirm("Are you sure you want to clear all entries? This cannot be undone.")) {
                fetch(`${BACKEND_URL}/clear`, {
                    method: 'POST',
                })
                .then(response => {
                    if (!response.ok) throw new Error('Clear failed');
                    alert('All entries cleared successfully!');
                    fetchRankings();
                })
                .catch(error => {
                    console.error('Error clearing entries:', error);
                    alert('Failed to clear entries. Please try again.');
                });
            }
        }

        // Initialize forms count
        updateFormsCount();
    </script>
</body>
</html>