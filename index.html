<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="apple-mobile-web-app-title" content="Perceptra">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="logo.png">
    <meta http-equiv="X-UA-Compatible" content="ie=chrome">
    <link rel="icon" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212"> <!-- Dark theme color -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="style.css">
    <style>

body {
  background-color: #121212;
  color: #fff;
  font-family: 'Segoe UI', sans-serif;
  padding: 2rem;
}

input, button {
  padding: 0.6rem 1rem;
  border-radius: 6px;
  border: none;
  margin-right: 10px;
  font-size: 1rem;
}

input {
  width: 200px;
}

button {
  background-color: #bb86fc;
  color: white;
  cursor: pointer;
}

button:disabled {
  background-color: #777;
  cursor: not-allowed;
}

        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            max-height: 100vh;
            overflow-y: auto;
            padding: 20px;
            background-color: #1e1e1e;
            box-sizing: border-box;
        }

        .perceptra-heading {
            color: #bb86fc; /* Purple accent color */
            text-align: center;
            margin-top: 0;
        }

        input, textarea, button, select {
            background-color: #333;
            color: #fff;
            border: 1px solid #444;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background-color: #6200ee;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            margin-top: 10px;
            width: auto;
        }

        button:hover {
            background-color: #3700b3;
        }

        .clear-all-btn {
            background-color: #cf6679;
            color: white;
        }

        .clear-all-btn:hover {
            background-color: #b00020;
        }

        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px 15px;
            background-color: #bb86fc;
            color: #000;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #332940;
            color: #bb86fc;
        }

        tr:nth-child(even) {
            background-color: #2a2a2a;
        }

        tr:hover {
            background-color: #383838;
        }

        .hidden {
            display: none;
        }

        .ratings input {
            width: 80px;
            margin-right: 10px;
        }

        #notes {
            width: 100%;
            min-height: 100px;
        }

        /* Updated Schedule styles */
        .schedule-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #332940;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .team-assignment {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #bb86fc;
            text-align: center;
        }

        .duty-block {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .duty-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .duty-matches {
            font-size: 0.9em;
        }

        .on-duty {
            background-color: #00c853;
            color: #000;
        }

        .off-duty {
            background-color: #616161;
            color: #fff;
        }

        .schedule-explanation {
            margin-top: 15px;
            font-style: italic;
            color: #9e9e9e;
            text-align: center;
        }

        #admin-login {
            margin-top: 20px;
            text-align: left;
        }

        /* Dark mode scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Prediction styles */
        .prediction-container {
            background-color: #332940;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .prediction-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .winning-team {
            background-color: #00c853;
            color: #000;
        }

        .losing-team {
            background-color: #b00020;
            color: #fff;
        }

        .close-prediction {
            background-color: #cf6679;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .duty-block {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="how-to-use-section">
        <button id="how-to-use-btn" onclick="goToHowToUse()">How to Use</button>
    </div>
    
    <script>
        function goToHowToUse() {
            window.location.href = "how-to-use.html";
        }
    </script>

<style>
    #how-to-use-section {
        margin-top: 20px;
        text-align: center;
    }

    #how-to-use-text {
        margin-top: 10px;
        background-color: #1e1e1e;
        padding: 10px;
        border-radius: 4px;
        color: #e0e0e0;
    }

    .hidden {
        display: none;
    }
</style>
    <div class="container">
        <h1 id="static-heading" class="perceptra-heading" style="display: none;">Perceptra</h1>
        <h2 id="welcome-message" class="perceptra-heading">Perceptra</h2>

        <div id="connection-status" class="connection-status hidden"></div>

        <div id="username-section">
            <label for="username">Enter your Full Name:</label>
            <input type="text" id="username" placeholder="Your Fullname">
            <button onclick="checkUsername()">Next</button>
            
            <div id="schedule-display" class="hidden schedule-container"></div>
            
            <!-- Add Match Prediction Button -->
            <button id="predict-match-btn" onclick="showPredictionForm()">Predict Match Outcome</button>
            
            <!-- Prediction Form (initially hidden) -->
            <div id="prediction-form" class="hidden prediction-container">
                <h3>Match Prediction</h3>
                <label for="red-team1">Red Alliance Team 1 Number:</label>
                <input type="number" id="red-team1" placeholder="Team Number">
                
                <label for="red-team2">Red Alliance Team 2 Number:</label>
                <input type="number" id="red-team2" placeholder="Team Number">
                
                <label for="blue-team1">Blue Alliance Team 1 Number:</label>
                <input type="number" id="blue-team1" placeholder="Team Number">
                
                <label for="blue-team2">Blue Alliance Team 2 Number:</label>
                <input type="number" id="blue-team2" placeholder="Team Number">
                
                <button onclick="calculatePrediction()">Calculate Prediction</button>
                <button class="close-prediction" onclick="hidePredictionForm()">Close</button>
                
                <div id="prediction-result" class="hidden prediction-result"></div>
            </div>
        </div>

        <div id="team-section" class="hidden">
            <label for="match-number">Match Number:</label>
            <input type="number" id="match-number" placeholder="Match Number">
            <!-- Event selection things -->
            <label for="event">Event:</label>
            <select id="event">
                <option value="">Select Event</option>
                <option value="LM1">LM1</option>
                <option value="LM2">LM2</option>
                <option value="LM3">LM3</option>
                <option value="LM4">LM4</option>
                <option value="LM5">LM5</option>
                <option value="LTC">LTC</option>
                <option value="MSC">MSC</option>
                <option value="FWC">FWC</option>
            </select>
            
            <label for="team-name">Enter Team Name:</label>
            <input type="text" id="team-name" placeholder="Team Name">
            <label for="team-number">Enter Team Number:</label>
            <input type="number" id="team-number" placeholder="Team Number">
            <div class="ratings">
                <label>Tell Amount Scored or Rate the Team (1-10): </label>
                <input type="number" id="defense" placeholder="Defense" min="1" max="10">
                <input type="number" id="strategy" placeholder="Strategy" min="1" max="10">
                <input type="number" id="effectiveness" placeholder="Effectiveness" min="1" max="10">
                <input type="number" id="drive-skill" placeholder="Drive Skill" min="1" max="10">
                <input type="number" id="scoring" placeholder="Scoring" min="1" max="10">
                <input type="number" id="consistency" placeholder="Consistency" min="1" max="10">
            </div>
            <textarea id="notes" placeholder="Additional Notes Add Autonomous and Endgame Info Here"></textarea>
            <button onclick="submitData()">Submit</button>
            <button onclick="goBack()">Back</button>
        </div>
        <!-- Add this inside your <body> -->
<div class="container">
    <h1>Team Performance Tracker</h1>
    <input type="text" id="teamIdInput" placeholder="Enter Team Number">
    <button id="loadBtn">Load Team Performance</button>
    <div id="error" style="color: #ff6b6b; margin-top: 1rem;"></div>
  
    <div id="chartContainer" style="display: none; margin-top: 2rem;">
      <canvas id="teamPerformanceChart"></canvas>
    </div>
  </div>
  

        <div id="admin-login">
            <button onclick="showAdmin()">Admin</button>
        </div>

        <div id="admin-section" class="hidden">
            <label for="admin-password">Enter Admin Password:</label>
            <input type="password" id="admin-password" placeholder="Enter Admin Password">
            <button onclick="accessAdmin()">Submit</button>
        </div>
        
        <div id="ai-insights-section">
            <h3>AI-Powered Insights</h3>
            <button onclick="generateAIInsights()">Generate Insights</button>
            <div id="ai-insights-result" class="hidden prediction-result"></div>
        </div>

        <div id="token-section">
            <p id="token-display">Game Tokens: 0</p>
            <button onclick="goToGame()">Play Game</button>
        </div>

        <div id="upload-section">
            <button id="upload-btn" onclick="uploadData()">Upload (<span id="forms-count">0</span>)</button>
        </div>

        <div id="rankings-section" class="hidden">
            <h2>Rankings</h2>
            <table id="rankings-table">
                <thead>
                    <tr>
                        <th>Match number</th>
                        <th>Event</th>
                        <th>Team Name</th>
                        <th>Team Number</th>
                        <th>Avg Score</th>
                        <th>Highest Score</th>
                        <th>Submitted By</th>
                        <th>Defense</th>
                        <th>Strategy</th>
                        <th>Effectiveness</th>
                        <th>Drive Skill</th>
                        <th>Scoring</th>
                        <th>Consistency</th>
                        <th>Notes</th>
                        <th>Saved At (Local)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="rankings-body"></tbody>
            </table>
            <button class="clear-all-btn" onclick="clearAllEntries()">Clear All</button>
        </div>
    </div>

    <script>
        let chart = null; // Declare chart globally
        const BACKEND_URL = "https://perceptra-backend2.onrender.com"; // Updated backend URL
        const loadBtn = document.getElementById('loadBtn');
        const teamIdInput = document.getElementById('teamIdInput');
        const chartContainer = document.getElementById('chartContainer');
        const ctx = document.getElementById('teamPerformanceChart').getContext('2d');
        const errorDiv = document.getElementById('error');
    
        loadBtn.addEventListener('click', async () => {
            errorDiv.textContent = "";
            chartContainer.style.display = "none";
    
            const teamId = teamIdInput.value.trim();
            if (!teamId) {
                errorDiv.textContent = "Please enter a valid team number.";
                return;
            }
    
            loadBtn.disabled = true;
            loadBtn.textContent = "Loading...";
    
            try {
                const response = await fetch(`${BACKEND_URL}/rankings`);
                if (!response.ok) throw new Error(`Error: ${response.status}`);
    
                const allData = await response.json();
                const teamData = allData
                    .filter(entry => entry.teamNumber === teamId)
                    .sort((a, b) => new Date(a._savedAt) - new Date(b._savedAt));
    
                if (teamData.length === 0) {
                    throw new Error("No data found for that team.");
                }
    
                const labels = teamData.map(entry => new Date(entry._savedAt).toLocaleString());
                const avgScores = teamData.map(entry => entry.avgScore);
    
                // Destroy the existing chart if it exists
                if (chart) {
                    chart.destroy();
                }
    
                // Create a new chart
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: `Avg Score for Team ${teamId}`,
                            data: avgScores,
                            borderColor: '#bb86fc',
                            backgroundColor: 'rgba(187,134,252,0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
    
                chartContainer.style.display = "block";
    
            } catch (err) {
                errorDiv.textContent = err.message || "Failed to load chart.";
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = "Load Team Performance";
            }
        });
        // Team assignments
        const scoutingTeams = {
            "Team 1": ["Joshua The", "Caleb Wieland", "Parker Montgomery", "Loriel Achonduh","Aiden Dejesus","Steve Freece", "Chloe Malcolm","Jessica Wash"],
            "Team 2": ["Nathan Hurd", "Bentley Kucmierz", "Evan Sylvester", "Kaila Petrut",]
        };

        const allowedUsernames = [...scoutingTeams["Team 1"], ...scoutingTeams["Team 2"]];

        function checkUsername() {
            const username = document.getElementById("username").value.trim();
            if (!username) {
                alert("Please enter a username");
                return;
            }
            
            if (!allowedUsernames.includes(username)) {
                alert(`${username} was not found in the database. Please contact Joshua or a mentor if you cannot get in.`);
                document.getElementById("username").value = "";
                return;
            }

            showUserSchedule(username);
        }

        function showUserSchedule(username) {
            const scheduleDisplay = document.getElementById("schedule-display");
            scheduleDisplay.innerHTML = '';
            scheduleDisplay.classList.remove("hidden");
            
            let userTeam = "Team 1";
            if (scoutingTeams["Team 2"].includes(username)) {
                userTeam = "Team 2";
            }
            
            const teamAssignment = document.createElement("div");
            teamAssignment.className = "team-assignment";
            teamAssignment.textContent = `You are on scouting ${userTeam}`;
            scheduleDisplay.appendChild(teamAssignment);

            // Create blocks for matches 1-100 in alternating 5-match periods
            for (let blockStart = 1; blockStart <= 100; blockStart += 5) {
                const blockEnd = Math.min(blockStart + 4, 100);
                // Alternate between on-duty and off-duty every 5 matches
                const isScouting = (Math.floor((blockStart - 1) / 5) % 2 === (userTeam === "Team 1" ? 0 : 1));

                const dutyBlock = document.createElement("div");
                dutyBlock.className = `duty-block ${isScouting ? "on-duty" : "off-duty"}`;
                dutyBlock.innerHTML = `
                    <div class="duty-title">${isScouting ? "ON" : "OFF"}</div>
                    <div class="duty-matches">Matches ${blockStart}-${blockEnd}</div>
                `;
                scheduleDisplay.appendChild(dutyBlock);
            }
            
            const explanation = document.createElement("div");
            explanation.className = "schedule-explanation";
            explanation.textContent = `You have 5 matches of scouting then 5 matches of a break`;
            scheduleDisplay.appendChild(explanation);
            
            const continueButton = document.createElement("button");
            continueButton.textContent = "Continue to Scouting";
            continueButton.onclick = () => proceedToScouting(username);
            scheduleDisplay.appendChild(continueButton);
        }

        function proceedToScouting(username) {
            document.getElementById("welcome-message").innerText = `Welcome back, ${username}`;
            document.getElementById("static-heading").style.display = "block";
            document.getElementById("username-section").classList.add("hidden");
            document.getElementById("team-section").classList.remove("hidden");
        }

        const LOCAL_STORAGE_KEY = "perceptra_unsynced_data";
        
        let isOnline = navigator.onLine;
        updateConnectionStatus();
        
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
        });
        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
        });

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = isOnline ? 'Online' : 'Offline';
            statusEl.style.backgroundColor = isOnline ? '#00FF00' : '#FF0000';
            statusEl.classList.remove('hidden');
        }

        function getUnsyncedData() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveToLocalStorage(data) {
            const unsyncedData = getUnsyncedData();
            
            // Add ONLY timestamp metadata
            data._savedAt = new Date().toISOString(); // ISO format: "2023-11-15T14:30:45.000Z"
            
            unsyncedData.push(data);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(unsyncedData));
            updateFormsCount();
        }

        function updateFormsCount() {
            document.getElementById('forms-count').textContent = getUnsyncedData().length;
        }

        function goBack() {
            document.getElementById("team-section").classList.add("hidden");
            document.getElementById("username-section").classList.remove("hidden");
            document.getElementById("static-heading").style.display = "none";
            document.getElementById("welcome-message").innerText = "Perceptra";
            document.getElementById("schedule-display").classList.add("hidden");
        }

        function showAdmin() {
            document.getElementById("admin-login").classList.add("hidden");
            document.getElementById("admin-section").classList.remove("hidden");
        }

        function accessAdmin() {
            const password = document.getElementById("admin-password").value.trim();
            if (password === "Quantum Toast") {
                alert("Access granted!");
                document.getElementById("admin-section").classList.add("hidden");
                document.getElementById("rankings-section").classList.remove("hidden");
                fetchRankings();
            } else {
                alert("Invalid password. Please try again.");
            }
        }

        function submitData() {
            const formData = {
                username: document.getElementById("username").value.trim(),
                matchNumber: document.getElementById("match-number").value.trim(),
                event: document.getElementById("event").value,
                teamName: document.getElementById("team-name").value.trim(),
                teamNumber: document.getElementById("team-number").value.trim(),
                defense: document.getElementById("defense").value,
                strategy: document.getElementById("strategy").value,
                effectiveness: document.getElementById("effectiveness").value,
                driveSkill: document.getElementById("drive-skill").value,
                scoring: document.getElementById("scoring").value,
                consistency: document.getElementById("consistency").value,
                notes: document.getElementById("notes").value.trim(),
                timestamp: new Date().toISOString()
            };

            if (!formData.teamName || !formData.teamNumber || !formData.matchNumber || !formData.event) {
                alert("Please enter all required fields (Team Name, Team Number, Match Number, and Event)");
                return;
            }

            saveToLocalStorage(formData);
            alert("Data saved locally!");
            console.log("Data saved locally:", formData);

            // Clear form
            document.getElementById("team-name").value = "";
            document.getElementById("team-number").value = "";
            document.getElementById("match-number").value = "";
            document.getElementById("event").value = "";
            document.getElementById("defense").value = "";
            document.getElementById("strategy").value = "";
            document.getElementById("effectiveness").value = "";
            document.getElementById("drive-skill").value = "";
            document.getElementById("scoring").value = "";
            document.getElementById("consistency").value = "";
            document.getElementById("notes").value = "";
        }

        function uploadData() {
            const unsyncedData = getUnsyncedData();
            
            if (unsyncedData.length === 0) {
                alert("No data to upload");
                return;
            }

            if (!isOnline) {
                alert("Cannot upload while offline");
                return;
            }

            uploadNextItem(0);
        }

        function uploadNextItem(index) {
            const unsyncedData = getUnsyncedData();
            
            if (index >= unsyncedData.length) {
                alert("All data uploaded successfully!");
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                console.log("All data uploaded successfully");
                updateFormsCount();
                return;
            }

            const dataItem = unsyncedData[index];
            
            fetch(`${BACKEND_URL}/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataItem)
            })
            .then(response => {
                if (!response.ok) throw new Error('Upload failed');
                
                const updatedData = getUnsyncedData();
                updatedData.splice(index, 1);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(updatedData));
                updateFormsCount();
                
                uploadNextItem(index);
            })
            .catch(error => {
                console.error('Error uploading item:', error);
                console.log("Failed to upload item:", dataItem);
                alert(`Failed to upload item ${index + 1}. Trying next item...`);
                uploadNextItem(index + 1);
            });
        }

        function fetchRankings() {
            fetch(`${BACKEND_URL}/rankings`)
                .then(response => response.json())
                .then(data => {
                    const rankingsBody = document.getElementById("rankings-body");
                    rankingsBody.innerHTML = "";
                    data.forEach((entry) => {
                        const row = rankingsBody.insertRow();
                        row.insertCell(0).innerText = entry.matchNumber || 'N/A';
                        row.insertCell(1).innerText = entry.event || 'N/A';
                        row.insertCell(2).innerText = entry.teamName;
                        row.insertCell(3).innerText = entry.teamNumber;
                        row.insertCell(4).innerText = entry.avgScore;
                        row.insertCell(5).innerText = entry.highestScore;
                        row.insertCell(6).innerText = entry.username;
                        row.insertCell(7).innerText = entry.defense;
                        row.insertCell(8).innerText = entry.strategy;
                        row.insertCell(9).innerText = entry.effectiveness;
                        row.insertCell(10).innerText = entry.driveSkill;
                        row.insertCell(11).innerText = entry.scoring;
                        row.insertCell(12).innerText = entry.consistency;
                        row.insertCell(13).innerText = entry.notes;
                        
                        // Add the saved timestamp (new cell at position 14)
                        const savedDate = entry._savedAt ? 
                            new Date(entry._savedAt).toLocaleString() : 
                            'Unknown';
                        row.insertCell(14).innerText = savedDate;

                        // Move delete button to cell 15
                        const deleteCell = row.insertCell(15);
                        const deleteButton = document.createElement("button");
                        deleteButton.innerText = "Delete";
                        deleteButton.style.backgroundColor = "#cf6679";
                        deleteButton.style.color = "white";
                        deleteButton.style.border = "none";
                        deleteButton.style.padding = "5px 10px";
                        deleteButton.style.cursor = "pointer";
                        deleteButton.onclick = () => deleteEntry(entry.teamNumber);
                        deleteCell.appendChild(deleteButton);
                    });
                })
                .catch(error => console.error("Error fetching rankings:", error));
        }
        
        function generateAIInsights() {
    const insightsResult = document.getElementById("ai-insights-result");
    const input = prompt("Enter one team number or two team numbers separated by a comma (e.g., 1234 or 1234,5678):");

    if (!input) {
        insightsResult.innerHTML = "No team number entered.";
        insightsResult.classList.remove("hidden");
        return;
    }

    const teamNumbers = input.split(',').map(num => num.trim());
    if (teamNumbers.length > 2) {
        insightsResult.innerHTML = "Please enter only one or two team numbers.";
        insightsResult.classList.remove("hidden");
        return;
    }

    insightsResult.innerHTML = `Fetching detailed insights for team(s): ${teamNumbers.join(", ")}...`;
    insightsResult.classList.remove("hidden");

    fetch(`${BACKEND_URL}/rankings`)
        .then(response => response.json())
        .then(data => {
            if (!data || data.length === 0) {
                insightsResult.innerHTML = "No data available to generate insights.";
                return;
            }

            const recentTeamData = teamNumbers.map(teamNumber => {
                const teamForms = data.filter(team => team.teamNumber == teamNumber);
                if (teamForms.length === 0) return null;
                return teamForms.sort((a, b) => new Date(b._savedAt) - new Date(a._savedAt))[0];
            });

            if (recentTeamData.includes(null)) {
                const missingTeams = teamNumbers.filter((_, index) => recentTeamData[index] === null);
                insightsResult.innerHTML = `No information found for team(s): ${missingTeams.join(", ")}.`;
                return;
            }

            function analyzeTeam(team) {
                const {
                    teamName = "Unknown",
                    avgScore,
                    highestScore,
                    defense,
                    strategy,
                    effectiveness,
                    driveSkill,
                    scoring,
                    consistency,
                    notes = "No additional notes available.",
                    username = "Unknown",
                    _savedAt
                } = team;

                const date = _savedAt ? new Date(_savedAt).toLocaleString() : "Unknown";

                let strengths = [];
                let weaknesses = [];

                if (scoring >= 8) strengths.push("high-scoring capability");
                else if (scoring <= 4) weaknesses.push("scoring consistency");

                if (defense >= 8) strengths.push("strong defensive presence");
                else if (defense <= 4) weaknesses.push("weak defensive play");

                if (driveSkill >= 8) strengths.push("excellent driver control");
                else if (driveSkill <= 4) weaknesses.push("driver control needs improvement");

                if (strategy >= 8) strengths.push("advanced strategic thinking");
                else if (strategy <= 4) weaknesses.push("unrefined strategy");

                if (consistency <= 4) weaknesses.push("lack of match-to-match consistency");

                let summary = `<h4>Team #${team.teamNumber} — ${teamName}</h4>`;
                summary += `<p><strong>Average Score:</strong> ${avgScore || "N/A"}<br>`;
                summary += `<strong>Highest Score:</strong> ${highestScore || "N/A"}</p>`;

                summary += `<p><strong>Performance Summary:</strong><br>`;
                summary += `This team ${strengths.length ? "shows strength in " + strengths.join(", ") + "." : "has a balanced but unremarkable profile."} `;
                summary += weaknesses.length ? `However, they may need to improve in areas like ${weaknesses.join(", ")}.` : "They have minimal weaknesses noted.";
                summary += `</p>`;

                summary += `<p><strong>Technical Ratings:</strong><br>`;
                summary += `Defense: ${defense || "N/A"} / 10<br>`;
                summary += `Strategy: ${strategy || "N/A"} / 10<br>`;
                summary += `Effectiveness: ${effectiveness || "N/A"} / 10<br>`;
                summary += `Drive Skill: ${driveSkill || "N/A"} / 10<br>`;
                summary += `Scoring: ${scoring || "N/A"} / 10<br>`;
                summary += `Consistency: ${consistency || "N/A"} / 10</p>`;

                summary += `<p><strong>Scout Notes:</strong> ${notes}</p>`;
                summary += `<p><strong>Submitted By:</strong> ${username}<br>`;
                summary += `<strong>Last Updated:</strong> ${date}</p>`;

                return summary;
            }

            function compareTeams(teamA, teamB) {
                const compareField = (field) => {
                    const a = teamA[field] || 0;
                    const b = teamB[field] || 0;
                    if (a > b) return `Team ${teamA.teamNumber} has a stronger ${field} (${a} vs ${b}).`;
                    if (b > a) return `Team ${teamB.teamNumber} leads in ${field} (${b} vs ${a}).`;
                    return `Both teams are equal in ${field} (${a}).`;
                };

                const fields = ['avgScore', 'highestScore', 'defense', 'strategy', 'effectiveness', 'driveSkill', 'scoring', 'consistency'];
                const comparisonResults = fields.map(compareField).join("<br>");

                return `<h4>Comparison Insights</h4><p>${comparisonResults}</p>`;
            }

            let html = "";

            if (recentTeamData.length === 1) {
                html = analyzeTeam(recentTeamData[0]);
            } else {
                html = analyzeTeam(recentTeamData[0]) + "<hr>" + analyzeTeam(recentTeamData[1]) + "<hr>" + compareTeams(recentTeamData[0], recentTeamData[1]);
            }

            insightsResult.innerHTML = html;
        })
        .catch(error => {
            console.error("Error fetching data for insights:", error);
            insightsResult.innerHTML = "Failed to fetch team information. Please try again.";
        });
}


        function deleteEntry(savedAt) {
    if (confirm("Are you sure you want to delete this entry?")) {
        fetch(`${BACKEND_URL}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ _savedAt: savedAt }) // Use "_savedAt" to match the backend
        })
        .then(response => {
            if (!response.ok) throw new Error('Delete failed');
            alert('Entry deleted successfully!');
            fetchRankings(); // Refresh the rankings table
        })
        .catch(error => {
            console.error('Error deleting entry:', error);
            alert('Failed to delete entry. Please try again.');
        });
    }
}

// Update the Rankings Table to Pass the Timestamp
function fetchRankings() {
    fetch(`${BACKEND_URL}/rankings`)
        .then(response => response.json())
        .then(data => {
            const rankingsBody = document.getElementById("rankings-body");
            rankingsBody.innerHTML = "";
            data.forEach((entry) => {
                const row = rankingsBody.insertRow();
                row.insertCell(0).innerText = entry.matchNumber || 'N/A';
                row.insertCell(1).innerText = entry.event || 'N/A';
                row.insertCell(2).innerText = entry.teamName;
                row.insertCell(3).innerText = entry.teamNumber;
                row.insertCell(4).innerText = entry.avgScore;
                row.insertCell(5).innerText = entry.highestScore;
                row.insertCell(6).innerText = entry.username;
                row.insertCell(7).innerText = entry.defense;
                row.insertCell(8).innerText = entry.strategy;
                row.insertCell(9).innerText = entry.effectiveness;
                row.insertCell(10).innerText = entry.driveSkill;
                row.insertCell(11).innerText = entry.scoring;
                row.insertCell(12).innerText = entry.consistency;
                row.insertCell(13).innerText = entry.notes;

                // Add the saved timestamp
                const savedDate = entry._savedAt
                    ? new Date(entry._savedAt).toLocaleString()
                    : 'Unknown';
                row.insertCell(14).innerText = savedDate;

                // Add delete button
                const deleteCell = row.insertCell(15);
                const deleteButton = document.createElement("button");
                deleteButton.innerText = "Delete";
                deleteButton.style.backgroundColor = "#cf6679";
                deleteButton.style.color = "white";
                deleteButton.style.border = "none";
                deleteButton.style.padding = "5px 10px";
                deleteButton.style.cursor = "pointer";
                deleteButton.onclick = () => deleteEntry(entry._savedAt); // Pass the timestamp
                deleteCell.appendChild(deleteButton);
            });
        })
        .catch(error => console.error("Error fetching rankings:", error));
}

        function clearAllEntries() {
            if (confirm("Are you sure you want to clear all entries? This cannot be undone.")) {
                fetch(`${BACKEND_URL}/clear`, {
                    method: 'POST',
                })
                .then(response => {
                    if (!response.ok) throw new Error('Clear failed');
                    alert('All entries cleared successfully!');
                    fetchRankings();
                })
                .catch(error => {
                    console.error('Error clearing entries:', error);
                    alert('Failed to clear entries. Please try again.');
                });
            }
        }
        const TOKEN_STORAGE_KEY = "game_tokens";

// Initialize tokens on page load
function initializeTokens() {
    const tokenCount = getTokenCount();
    updateTokenDisplay(tokenCount);
}

// Get the current token count from local storage
function getTokenCount() {
    return parseInt(localStorage.getItem(TOKEN_STORAGE_KEY)) || 0;
}

// Save the token count to local storage
function saveTokenCount(count) {
    localStorage.setItem(TOKEN_STORAGE_KEY, count);
}

// Award a token when a form is saved
function awardToken() {
    let tokenCount = getTokenCount();
    tokenCount++;
    saveTokenCount(tokenCount);
    updateTokenDisplay(tokenCount);
}

// Update the token display
function updateTokenDisplay(count) {
    const tokenDisplay = document.getElementById("token-display");
    if (tokenDisplay) {
        tokenDisplay.textContent = `Game Tokens: ${count}`;
    }
}

// Redirect to the game page
function goToGame() {
    const tokenCount = getTokenCount();
    if (tokenCount > 0) {
        saveTokenCount(tokenCount - 1); // Deduct one token
        updateTokenDisplay(tokenCount - 1);
        window.location.href = "game.html";
    } else {
        alert("You need at least 1 token to play the game!");
    }
}

// Call this function in your submitData function after saving the form
function submitData() {
    const formData = {
        username: document.getElementById("username").value.trim(),
        matchNumber: document.getElementById("match-number").value.trim(),
        event: document.getElementById("event").value,
        teamName: document.getElementById("team-name").value.trim(),
        teamNumber: document.getElementById("team-number").value.trim(),
        defense: document.getElementById("defense").value,
        strategy: document.getElementById("strategy").value,
        effectiveness: document.getElementById("effectiveness").value,
        driveSkill: document.getElementById("drive-skill").value,
        scoring: document.getElementById("scoring").value,
        consistency: document.getElementById("consistency").value,
        notes: document.getElementById("notes").value.trim(),
        timestamp: new Date().toISOString()
    };

    if (!formData.teamName || !formData.teamNumber || !formData.matchNumber || !formData.event) {
        alert("Please enter all required fields (Team Name, Team Number, Match Number, and Event)");
        return;
    }

    saveToLocalStorage(formData);
    alert("Data saved locally!");
    console.log("Data saved locally:", formData);

    // Award a token
    awardToken();

    // Clear form
    document.getElementById("team-name").value = "";
    document.getElementById("team-number").value = "";
    document.getElementById("match-number").value = "";
    document.getElementById("event").value = "";
    document.getElementById("defense").value = "";
    document.getElementById("strategy").value = "";
    document.getElementById("effectiveness").value = "";
    document.getElementById("drive-skill").value = "";
    document.getElementById("scoring").value = "";
    document.getElementById("consistency").value = "";
    document.getElementById("notes").value = "";
}

// Initialize tokens when the page loads
window.onload = initializeTokens;

// Call this function in your submitData function after saving the form
function submitData() {
    const formData = {
        username: document.getElementById("username").value.trim(),
        matchNumber: document.getElementById("match-number").value.trim(),
        event: document.getElementById("event").value,
        teamName: document.getElementById("team-name").value.trim(),
        teamNumber: document.getElementById("team-number").value.trim(),
        defense: document.getElementById("defense").value,
        strategy: document.getElementById("strategy").value,
        effectiveness: document.getElementById("effectiveness").value,
        driveSkill: document.getElementById("drive-skill").value,
        scoring: document.getElementById("scoring").value,
        consistency: document.getElementById("consistency").value,
        notes: document.getElementById("notes").value.trim(),
        timestamp: new Date().toISOString()
    };

    if (!formData.teamName || !formData.teamNumber || !formData.matchNumber || !formData.event) {
        alert("Please enter all required fields (Team Name, Team Number, Match Number, and Event)");
        return;
    }

    saveToLocalStorage(formData);
    alert("Data saved locally!");
    console.log("Data saved locally:", formData);

    // Award a token
    awardToken();

    // Clear form
    document.getElementById("team-name").value = "";
    document.getElementById("team-number").value = "";
    document.getElementById("match-number").value = "";
    document.getElementById("event").value = "";
    document.getElementById("defense").value = "";
    document.getElementById("strategy").value = "";
    document.getElementById("effectiveness").value = "";
    document.getElementById("drive-skill").value = "";
    document.getElementById("scoring").value = "";
    document.getElementById("consistency").value = "";
    document.getElementById("notes").value = "";
}

        // Match Prediction Functions
        function showPredictionForm() {
            document.getElementById("prediction-form").classList.remove("hidden");
            document.getElementById("predict-match-btn").classList.add("hidden");
        }

        function hidePredictionForm() {
            document.getElementById("prediction-form").classList.add("hidden");
            document.getElementById("predict-match-btn").classList.remove("hidden");
            document.getElementById("prediction-result").classList.add("hidden");
        }

        function calculatePrediction() {
            const redTeam1 = document.getElementById("red-team1").value.trim();
            const redTeam2 = document.getElementById("red-team2").value.trim();
            const blueTeam1 = document.getElementById("blue-team1").value.trim();
            const blueTeam2 = document.getElementById("blue-team2").value.trim();
            
            if (!redTeam1 || !blueTeam1) {
                alert("Please enter at least one team for each alliance");
                return;
            }
            
            // Get all team data
            fetch(`${BACKEND_URL}/rankings`)
                .then(response => response.json())
                .then(data => {
                    // Find each team's data
                    const red1Data = data.find(team => team.teamNumber == redTeam1);
                    const red2Data = data.find(team => team.teamNumber == redTeam2);
                    const blue1Data = data.find(team => team.teamNumber == blueTeam1);
                    const blue2Data = data.find(team => team.teamNumber == blueTeam2);
                    
                    // Calculate average scores for each alliance
                    const redScores = [];
                    const blueScores = [];
                    
                    if (red1Data) redScores.push(parseFloat(red1Data.avgScore) || 0);
                    if (red2Data) redScores.push(parseFloat(red2Data.avgScore) || 0);
                    if (blue1Data) blueScores.push(parseFloat(blue1Data.avgScore) || 0);
                    if (blue2Data) blueScores.push(parseFloat(blue2Data.avgScore) || 0);
                    
                    // If no data for a team, use default score (1)
                    if (redScores.length === 0) redScores.push(1);
                    if (blueScores.length === 0) blueScores.push(1);
                    
                    const redAvg = redScores.reduce((a, b) => a + b, 0) / redScores.length;
                    const blueAvg = blueScores.reduce((a, b) => a + b, 0) / blueScores.length;
                    
                    // Calculate win probability (simple logistic function)
                    const total = redAvg + blueAvg;
                    const redWinProb = Math.round((redAvg / total) * 100);
                    const blueWinProb = 100 - redWinProb;
                    
                    // Display results
                    const resultEl = document.getElementById("prediction-result");
                    resultEl.innerHTML = '';
                    resultEl.classList.remove("hidden");
                    
                    if (redAvg > blueAvg) {
                        resultEl.innerHTML = `
                            <div class="winning-team">RED Alliance predicted to win (${redWinProb}% chance)</div>
                            <div class="losing-team">BLUE Alliance predicted to lose (${blueWinProb}% chance)</div>
                            <div>Red Alliance Average Score: ${redAvg.toFixed(1)}</div>
                            <div>Blue Alliance Average Score: ${blueAvg.toFixed(1)}</div>
                        `;
                    } else {
                        resultEl.innerHTML = `
                            <div class="winning-team">BLUE Alliance predicted to win (${blueWinProb}% chance)</div>
                            <div class="losing-team">RED Alliance predicted to lose (${redWinProb}% chance)</div>
                            <div>Blue Alliance Average Score: ${blueAvg.toFixed(1)}</div>
                            <div>Red Alliance Average Score: ${redAvg.toFixed(1)}</div>
                        `;
                    }
                })
                .catch(error => {
                    console.error("Error fetching team data:", error);
                    alert("Error calculating prediction. Please try again.");
                });
        }

        updateFormsCount();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        
    </script>
</body>
</html>